@page "/vendor/listings/create"
@inject NavigationManager Nav
@using GameVault.Client.Models
@using GameVault.Client.Services
@using GameVault.Shared.DTOs
@using GameVault.Shared.Models
@inject Services.ListingService ListingService
@inject ProductService ProductService
@inject BreadcrumbService BreadcrumbService

<h3>Create Listing</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success">@successMessage</div>
}

<EditForm Model="@model" OnValidSubmit="@HandleCreate">
  <div style="margin-bottom:8px;">
    <label>Name</label><br />
    <InputText @bind-Value="model.Name" />
  </div>
  <div style="margin-bottom:8px;">
    <label>Description</label><br />
    <InputText @bind-Value="model.Description" />
  </div>
  <div style="margin-bottom:8px;">
    <label>Price</label><br />
    <InputNumber @bind-Value="model.Price" />
  </div>
  <div style="margin-bottom:8px;">
    <label>Stock</label><br />
    <InputNumber @bind-Value="model.Stock" />
  </div>
  <div style="margin-bottom:8px;">
    <label>Category</label>
    <select class="form-select" @bind="model.Category">
      <option value="">Select a category</option>
      @if (categories is not null)
      {
        @foreach (CategoryDTO category in categories)
        {
          <option value="@category.Id">@category.Name</option>
        }
      }
    </select>
  </div>
  <button type="submit" disabled="@isSubmitting">
    @if (isSubmitting)
    {
        <span>Creating...</span>
    }
    else
    {
        <span>Create Listing</span>
    }
  </button>
</EditForm>

@code {
  private EditableListing model = new()
  {
    Name = "",
    Description = "",
    Price = 0.0M,
    Stock = 0,
    Category = ""
  };

  private List<CategoryDTO>? categories = [];
  private bool isSubmitting = false;
  private string errorMessage = "";
  private string successMessage = "";

  protected override async Task OnInitializedAsync()
  {
    await LoadCategories();
    BreadcrumbService.Set(
      new BreadcrumbItem("Home", "/"),
      new BreadcrumbItem("Vendor Dashboard", "/vendor"),
      new BreadcrumbItem("Create Listing")
    );
  }

  private async Task LoadCategories()
  {
    categories = await ProductService.GetCategoriesAsync();
  }

  private async Task HandleCreate()
  {
    isSubmitting = true;
    errorMessage = "";
    successMessage = "";

    var result = await ListingService.CreateAsync(
      model.Name, 
      model.Price, 
      model.Description, 
      model.Stock, 
      model.Category ?? ""
    );

    isSubmitting = false;

    if (result is { Success: true })
    {
      Console.WriteLine("Creation Success!");
      successMessage = "Listing created successfully!";
      
      await Task.Delay(1000);
      Nav.NavigateTo("/vendor/listings");
    }
    else
    {
      errorMessage = result?.Message ?? "Failed to create listing. Please try again.";
      Console.WriteLine(errorMessage);
    }
  }
}