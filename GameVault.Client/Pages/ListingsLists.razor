@page "/viewListings/{StatusFilter}"
@inject NavigationManager Nav
@inject Services.ListingService ListingService
@inject Services.AuthService AuthService
@inject Services.LogService LogService
@using GameVault.Client.Services
@using System.Runtime.CompilerServices
@using GameVault.Shared.Models
@using System.Reflection
@using GameVault.Shared.DTOs
@using Grpc.Net.Client.Balancer
@inject BreadcrumbService BreadcrumbService


<h3>@PageTitle</h3>
<header>
    <nav>
        <ul>
            <li>
                <p><a href="/viewListings/pendingListings">Pending Listings</a></p>
            </li>
            <li>
                <p><a href="/viewListings/publishedListings">Published Listings</a></p>
            </li>
            <li>
                <p><a href="/viewListings/removedListings">Removed Listings</a></p>
            </li>
            <li>
                <p><a href="/viewListings/unpublishedListings">Unpublished Listings</a></p>
            </li>
        </ul>
    </nav>
</header>

@if (entries == null)
{
    <p><em>Loading...</em></p>
}
else if (entries.Count == 0)
{
    <p><em>No accounts found with status "@StatusFilter".</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>User</th>
                @if (filter == ListingStatus.Published) {
                    <th>Rating</th>
                }
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in entries)
            {
                <tr>
                    <td>
                        @if (StatusFilter == "pendingListings")
                        {
                            <a @onclick="() => OpenModal(entry)">@entry.Name</a>
                        }
                        else
                        {
                            @entry.Name
                        }
                    </td>
                    <td>@entry.OwnerID</td>
                    @if (filter == ListingStatus.Published) {
                    @if (entry.NumReviews > 0)
                    {
                        <td><i class="bi bi-hand-thumbs-up"></i> @(entry.Rating)% | @entry.NumReviews
                            review@(entry.NumReviews == 1 ? "" : "s")</td>
                    }
                    else
                    {
                        <td><i class="bi bi-hand-thumbs-up"></i> -% | No reviews</td>
                    }
                    }
                    <td>@entry.Status</td>
                </tr>
            }
        </tbody>
    </table>
}

@if (showModal && selectedEntry != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl" style="max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-content" style="max-height: 90vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <h5 class="modal-title">@selectedEntry.Name Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body p-0" style="flex: 1; overflow: hidden;">
                    <iframe src="@selectedPageUrl" width="100%" height="100%" frameborder="0" style="display: block;"></iframe>
                </div>
                <div class="modal-footer bg-light p-3 d-flex justify-content-between gap-2" style="flex-shrink: 0;">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                        Close
                    </button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" @onclick="HandleApprove">
                            Approve
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="HandleDeny">
                            Deny
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public string StatusFilter { get; set; } = string.Empty;
    public ListingStatus filter = 0;
    private List<VendorListingDTO>? entries;
    private VendorListingDTO? selectedEntry;
    private string? selectedPageUrl;

    private bool showModal;


    private string PageTitle =>
    StatusFilter switch
    {
        "pendingListings" => "Pending Product Listings",
        "publishedListings" => "Published Product Listings",
        "removedListings" => "Removed Product Listings",
        "unpublishedListings" => "Unpublished Product Listings",
        _ => "Listings"
    };


    protected override async Task OnParametersSetAsync()
    {
        BreadcrumbService.Set(
            new BreadcrumbItem("Admin Dashboard", "/adminLanding"),
            new BreadcrumbItem("Listing Management", "/viewListings"),
            new BreadcrumbItem(PageTitle)
        );
        await LoadData();
    }

    private async Task LoadData()
    {
        entries = null;

        try
        {
            filter = MapStatus(StatusFilter);
            ListResponse<VendorListingDTO> result = await ListingService.GetListingsByStatus(filter);
            entries = result.List;
            Console.WriteLine($"Got entries {entries?.Count ?? -1}");
            await InvokeAsync(StateHasChanged);

        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading Firebase data: {ex.Message}");
            entries = new();
        }
    }

    private ListingStatus MapStatus(string StatusFilter)
    {
        return StatusFilter switch
        {
            "pendingListings" => ListingStatus.Pending,
            "publishedListings" => ListingStatus.Published,
            "removedListings" => ListingStatus.Removed,
            "unpublishedListings" => ListingStatus.Inactive,
            _ => ListingStatus.Inactive
        };
    }

    private void OpenModal(VendorListingDTO entry)
    {
        selectedEntry = entry;
        selectedPageUrl = $"/product/{entry.Id}?modal=true";
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        selectedEntry = null;
    }

    private async Task HandleApprove()
    {
        if (selectedEntry == null) return;
        
        await ListingService.ChangeListingStatusToPublished(selectedEntry.Id);
        await LogService.LogListingStatusChangeAsync(selectedEntry.Id, "pending", "published");
        CloseModal();
        await LoadData();
    }

    private async Task HandleDeny()
    {
        if (selectedEntry == null) return;
        
        await ListingService.ChangeListingStatusToInactive(selectedEntry.Id);
        await LogService.LogListingStatusChangeAsync(selectedEntry.Id, "pending", "inactive");
        CloseModal();
        await LoadData();
    }
}