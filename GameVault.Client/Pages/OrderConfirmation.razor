@page "/order-confirmation/{OrderId}"
@attribute [Authorize(Roles = "Customer")]
@using GameVault.Client.Services
@using GameVault.Shared.DTOs
@inject CheckoutService CheckoutService
@inject NavigationManager Navigation
@inject BreadcrumbService BreadcrumbService

<PageTitle>Order Confirmation - GameVault</PageTitle>

<div class="container py-4">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading order details...</p>
        </div>
    }
    else if (order is null)
    {
        <div class="alert alert-danger">
            <h4 class="alert-heading">Order not found</h4>
            <p>We couldn't find your order. Please check your email for confirmation.</p>
        </div>
    }
    else
    {
        <div class="card border-success mb-4">
            <div class="card-body text-center py-5">
                <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                <h1 class="mt-3 mb-2">Order Confirmed!</h1>
                <p class="text-muted fs-5">Thank you for your purchase</p>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title h5 mb-3">Order Details</h2>

                <div class="row border-bottom py-2">
                    <div class="col-6 text-muted">Order Number:</div>
                    <div class="col-6 text-end"><code>@order.Id</code></div>
                </div>

                <div class="row border-bottom py-2">
                    <div class="col-6 text-muted">Order Date:</div>
                    <div class="col-6 text-end fw-medium">@order.OrderDate.ToLocalTime().ToString("MMMM dd, yyyy h:mm tt")
                    </div>
                </div>

                <div class="row border-bottom py-2">
                    <div class="col-6 text-muted">Subtotal:</div>
                    <div class="col-6 text-end fw-medium">@FormatPrice(order.SubtotalInCents)</div>
                </div>

                <div class="row border-bottom py-2">
                    <div class="col-6 text-muted">Tax:</div>
                    <div class="col-6 text-end fw-medium">@FormatPrice(order.TaxInCents)</div>
                </div>

                <div class="row py-3">
                    <div class="col-6 fs-5 fw-bold">Total:</div>
                    <div class="col-6 text-end fs-5 fw-bold">@FormatPrice(order.TotalInCents)</div>
                </div>
            </div>
        </div>

        <div class="card bg-light mb-4">
            <div class="card-body">
                <h2 class="card-title h5 mb-3">What's Next?</h2>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        You'll receive a confirmation email shortly
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Vendors will process your order and ship items separately
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Track your order status in Order History
                    </li>
                </ul>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <button @onclick="ViewOrderHistory" class="btn btn-primary w-100">
                    View Order History
                </button>
            </div>
            <div class="col-md-6">
                <button @onclick="ContinueShopping" class="btn btn-outline-secondary w-100">
                    Continue Shopping
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string OrderId { get; set; } = string.Empty;

    private OrderDTO? order;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        BreadcrumbService.Set(
        new BreadcrumbItem("Home", "/"),
        new BreadcrumbItem("Order Confirmation")
        );
        if (!string.IsNullOrEmpty(OrderId))
        {
            order = await CheckoutService.GetOrderAsync(OrderId);
        }

        isLoading = false;
    }

    private string FormatPrice(int cents)
    {
        return $"${cents / 100.0:F2}";
    }

    private void ViewOrderHistory()
    {
        Navigation.NavigateTo("/orders");
    }

    private void ContinueShopping()
    {
        Navigation.NavigateTo("/");
    }
}