@page "/checkout"
@using GameVault.Shared.DTOs
@using GameVault.Shared.Models
@using GameVault.Client.Services
@inject CheckoutService CheckoutService
@inject NavigationManager Navigation
@inject ILogger<Checkout> Logger

<PageTitle>Checkout - GameVault</PageTitle>

<div class="container py-4">
    <h1 class="mb-4">Checkout</h1>

    @if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Processing your order...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }
    else
    {
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h2 class="card-title h5 mb-3">1. Shipping Address</h2>
                        <ShipAddressForm 
                            Address="@shippingAddress" 
                            OnAddressChanged="@HandleAddressChanged" />
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title h5 mb-3">2. Payment Information</h2>
                        <SquarePaymentForm 
                            OnPaymentMethodCreated="@HandlePaymentMethodCreated"
                            IsEnabled="@isAddressComplete" />
                        
                        @if (!isAddressComplete)
                        {
                            <p class="text-muted small mt-2">
                                Please complete the shipping address first.
                            </p>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-body">
                        <h2 class="card-title h5 mb-3">Order Summary</h2>
                        <OrderSummary 
                            SubtotalInCents="@subtotalInCents"
                            TaxInCents="@taxInCents"
                            TotalInCents="@totalInCents"
                            State="@shippingAddress.State" />
                        
                        <button 
                            @onclick="ProcessCheckout"
                            disabled="@(!canCheckout || isProcessing)"
                            class="btn btn-primary w-100 mt-3">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Processing...</span>
                            }
                            else
                            {
                                <span>Place Order</span>
                            }
                        </button>

                        @if (!canCheckout && !isProcessing)
                        {
                            <p class="text-danger small text-center mt-2 mb-0">
                                Please complete all required fields
                            </p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private Address shippingAddress = new()
    {
        Street = "",
        City = "",
        State = "",
        PostalCode = "",
        Country = "US"
    };

    private string? paymentMethodId;

    private int subtotalInCents = 0;
    private int taxInCents = 0;
    private int totalInCents = 0;

    private bool isProcessing = false;
    private string? errorMessage;
    private bool isAddressComplete => 
        !string.IsNullOrWhiteSpace(shippingAddress.Street) &&
        !string.IsNullOrWhiteSpace(shippingAddress.City) &&
        !string.IsNullOrWhiteSpace(shippingAddress.State) &&
        !string.IsNullOrWhiteSpace(shippingAddress.PostalCode);
    
    private bool canCheckout => 
        isAddressComplete && 
        !string.IsNullOrEmpty(paymentMethodId) &&
        !isProcessing;

    protected override async Task OnInitializedAsync()
    {
        // for testing
        subtotalInCents = 2000;
        
        await EstimateTax();
    }

    private async void HandleAddressChanged(Address address)
    {
        shippingAddress = address;

        if (!string.IsNullOrEmpty(address.State))
        {
            await EstimateTax();
        }
        
        StateHasChanged();
    }

    private void HandlePaymentMethodCreated(string methodId)
    {
        paymentMethodId = methodId;
        errorMessage = null;
        StateHasChanged();
    }

    private async Task EstimateTax()
    {
        if (string.IsNullOrEmpty(shippingAddress.State) || subtotalInCents <= 0)
        {
            return;
        }

        var taxEstimate = await CheckoutService.EstimateTaxAsync(subtotalInCents, shippingAddress.State);
        if (taxEstimate != null)
        {
            taxInCents = taxEstimate.TaxInCents;
            totalInCents = taxEstimate.TotalInCents;
            StateHasChanged();
        }
    }

    private async Task ProcessCheckout()
    {
        if (!canCheckout)
        {
            return;
        }

        isProcessing = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var request = new CheckoutRequestDTO
            {
                PaymentMethodId = paymentMethodId!,
                ShipTo = shippingAddress
            };

            var response = await CheckoutService.ProcessCheckoutAsync(request);

            if (response.Success)
            {
                Logger.LogInformation("Checkout successful, order ID: {orderId}", response.OrderId);
                Navigation.NavigateTo($"/order-confirmation/{response.OrderId}");
            }
            else
            {
                errorMessage = response.ErrorMessage ?? "Checkout failed. Please try again.";
                Logger.LogWarning("Checkout failed: {error}", errorMessage);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error during checkout");
            errorMessage = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }
}